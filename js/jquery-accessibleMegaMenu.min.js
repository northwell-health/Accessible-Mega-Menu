(function($,j,k){"use strict";var l="accessibleMegaMenu",defaults={uuidPrefix:"accessible-megamenu",menuSelector:"> *:first",menuClass:"accessible-megamenu",topNavItemClass:"accessible-megamenu-top-nav-item",panelClass:"accessible-megamenu-panel",panelGroupClass:"accessible-megamenu-panel-group",hoverClass:"hover",focusClass:"focus",openClass:"open"},Keyboard={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38,keyMap:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",190:"."}};function AccessibleMegaMenu(a,b){this.element=a;this.settings=$.extend({},defaults,b);this._defaults=defaults;this._name=l;this.mouseTimeoutID=null;this.focusTimeoutID=null;this.mouseFocused=false;this.justFocused=false;this.init()}AccessibleMegaMenu.prototype=(function(){var h=0,keydownTimeoutDuration=1000,keydownSearchString="",isTouch=typeof j.hasOwnProperty==="function"&&!!j.hasOwnProperty("ontouchstart"),_getPlugin,_addUniqueId,_togglePanel,_clickHandler,_clickOutsideHandler,_DOMAttrModifiedHandler,_focusInHandler,_focusOutHandler,_keyDownHandler,_mouseDownHandler,_mouseOverHandler,_mouseOutHandler,_toggleExpandedEventHandlers;_getPlugin=function(a){return $(a).closest(':data(plugin_'+l+')').data("plugin_"+l)};_addUniqueId=function(a){a=$(a);var b=this.settings;if(!a.attr("id")){a.attr("id",b.uuidPrefix+"-"+new Date().getTime()+"-"+(++h))}};_togglePanel=function(a,b){var c=$(a.target),that=this,settings=this.settings,menu=this.menu,topli=c.closest('.'+settings.topNavItemClass),panel=c.hasClass(settings.panelClass)?c:c.closest('.'+settings.panelClass),newfocus;if(!topli.length)topli=menu.find('.'+settings.topNavItemClass+'.'+settings.openClass);_toggleExpandedEventHandlers.call(this,true);if(b){topli.removeClass(settings.openClass);topli=menu.find('.'+settings.topNavItemClass+' .'+settings.openClass+':first').closest('.'+settings.topNavItemClass);if(!(topli.is(a.relatedTarget)||topli.has(a.relatedTarget).length>0)){if((a.type==='mouseout'||a.type==='focusout')&&topli.has(k.activeElement).length>0){return}topli.find('[aria-expanded]').attr('aria-expanded','false').removeClass(settings.openClass).filter('.'+settings.panelClass).attr('aria-hidden','true');if((a.type==='keydown'&&a.keyCode===Keyboard.ESCAPE)||a.type==='DOMAttrModified'){newfocus=topli.find(':tabbable:first');setTimeout(function(){menu.find('[aria-expanded].'+that.settings.panelClass).off('DOMAttrModified.accessible-megamenu');newfocus.focus();that.justFocused=false},99)}}else if(topli.length===0){menu.find('[aria-expanded=true]').attr('aria-expanded','false').removeClass(settings.openClass).filter('.'+settings.panelClass).attr('aria-hidden','true')}}else{clearTimeout(that.focusTimeoutID);menu.find('.'+settings.topNavItemClass+'.'+settings.openClass).not(topli).removeClass(settings.openClass);topli.siblings().find('[aria-expanded]').attr('aria-expanded','false').removeClass(settings.openClass).filter('.'+settings.panelClass).attr('aria-hidden','true');topli.find('[aria-expanded]').attr('aria-expanded','true').addClass(settings.openClass).filter('.'+settings.panelClass).attr('aria-hidden','false');topli.addClass(settings.openClass);if(a.type==='mouseover'&&c.is(':tabbable')&&topli.length===1&&panel.length===0&&menu.has(k.activeElement).length>0){c.focus();that.justFocused=false}_toggleExpandedEventHandlers.call(that)}};_clickHandler=function(a){var b=$(a.currentTarget),topli=b.closest('.'+this.settings.topNavItemClass),panel=b.closest('.'+this.settings.panelClass);if(topli.length===1&&panel.length===0&&topli.find('.'+this.settings.panelClass).length===1){clearTimeout(this.focusTimeoutID);if(!b.hasClass(this.settings.openClass)&&!topli.hasClass(this.settings.openClass)){a.preventDefault();a.stopPropagation();_togglePanel.call(this,a);this.justFocused=false}else{if(this.justFocused){a.preventDefault();a.stopPropagation();this.justFocused=false}else if(isTouch){a.preventDefault();a.stopPropagation();_togglePanel.call(this,a,b.hasClass(this.settings.openClass)||topli.hasClass(this.settings.openClass))}}}};_clickOutsideHandler=function(a){clearTimeout(this.focusTimeoutID);if($(a.target).closest(this.menu).length===0){a.preventDefault();a.stopPropagation();_togglePanel.call(this,a,true)}};_DOMAttrModifiedHandler=function(a){if(a.originalEvent.attrName==='aria-expanded'&&a.originalEvent.newValue==='false'&&$(a.target).hasClass(this.settings.openClass)){a.preventDefault();a.stopPropagation();_togglePanel.call(this,a,true)}};_focusInHandler=function(a){clearTimeout(this.focusTimeoutID);var b=$(a.target),panel=b.closest('.'+this.settings.panelClass);b.addClass(this.settings.focusClass).on('click.accessible-megamenu',$.proxy(_clickHandler,this));this.justFocused=!this.mouseFocused;this.mouseFocused=false;if(this.panels.not(panel).filter('.'+this.settings.openClass).length){_togglePanel.call(this,a)}};_focusOutHandler=function(e){this.justFocused=false;var f=this,target=$(e.target),topli=target.closest('.'+this.settings.topNavItemClass),keepOpen=false;target.removeClass(this.settings.focusClass).off('click.accessible-megamenu');if(j.cvox){f.focusTimeoutID=setTimeout(function(){j.cvox.Api.getCurrentNode(function(d){if(topli.has(d).length){clearTimeout(f.focusTimeoutID)}else{f.focusTimeoutID=setTimeout(function(a,b,c){_togglePanel.call(a,b,c)},275,f,e,true)}})},25)}else{f.focusTimeoutID=setTimeout(function(){_togglePanel.call(f,e,true)},300)}};_keyDownHandler=function(a){var b=(this.constructor===AccessibleMegaMenu)?this:_getPlugin(this),settings=b.settings,target=$($(this).is('.'+settings.hoverClass+':tabbable')?this:a.target),menu=b.menu,topnavitems=b.topnavitems,topli=target.closest('.'+settings.topNavItemClass),tabbables=menu.find(':tabbable'),panel=target.hasClass(settings.panelClass)?target:target.closest('.'+settings.panelClass),panelGroups=panel.find('.'+settings.panelGroupClass),currentPanelGroup=target.closest('.'+settings.panelGroupClass),next,keycode=a.keyCode||a.which,start,i,o,label,found=false,newString=Keyboard.keyMap[a.keyCode]||'',regex,isTopNavItem=(topli.length===1&&panel.length===0);if(target.is("input:focus, select:focus, textarea:focus, button:focus")){return}if(target.is('.'+settings.hoverClass+':tabbable')){$('html').off('keydown.accessible-megamenu')}switch(keycode){case Keyboard.ESCAPE:_togglePanel.call(b,a,true);break;case Keyboard.DOWN:a.preventDefault();if(isTopNavItem){_togglePanel.call(b,a);found=(topli.find('.'+settings.panelClass+' :tabbable:first').focus().length===1)}else{found=(tabbables.filter(':gt('+tabbables.index(target)+'):first').focus().length===1)}if(!found&&j.opera&&opera.toString()==="[object Opera]"&&(a.ctrlKey||a.metaKey)){tabbables=$(':tabbable');i=tabbables.index(target);found=($(':tabbable:gt('+$(':tabbable').index(target)+'):first').focus().length===1)}break;case Keyboard.UP:a.preventDefault();if(isTopNavItem&&target.hasClass(settings.openClass)){_togglePanel.call(b,a,true);next=topnavitems.filter(':lt('+topnavitems.index(topli)+'):last');if(next.children('.'+settings.panelClass).length){found=(next.children().attr('aria-expanded','true').addClass(settings.openClass).filter('.'+settings.panelClass).attr('aria-hidden','false').find(':tabbable:last').focus()===1)}}else if(!isTopNavItem){found=(tabbables.filter(':lt('+tabbables.index(target)+'):last').focus().length===1)}if(!found&&j.opera&&opera.toString()==="[object Opera]"&&(a.ctrlKey||a.metaKey)){tabbables=$(':tabbable');i=tabbables.index(target);found=($(':tabbable:lt('+$(':tabbable').index(target)+'):first').focus().length===1)}break;case Keyboard.RIGHT:a.preventDefault();if(isTopNavItem){found=(topnavitems.filter(':gt('+topnavitems.index(topli)+'):first').find(':tabbable:first').focus().length===1)}else{if(panelGroups.length&&currentPanelGroup.length){found=(panelGroups.filter(':gt('+panelGroups.index(currentPanelGroup)+'):first').find(':tabbable:first').focus().length===1)}if(!found){found=(topli.find(':tabbable:first').focus().length===1)}}break;case Keyboard.LEFT:a.preventDefault();if(isTopNavItem){found=(topnavitems.filter(':lt('+topnavitems.index(topli)+'):last').find(':tabbable:first').focus().length===1)}else{if(panelGroups.length&&currentPanelGroup.length){found=(panelGroups.filter(':lt('+panelGroups.index(currentPanelGroup)+'):last').find(':tabbable:first').focus().length===1)}if(!found){found=(topli.find(':tabbable:first').focus().length===1)}}break;case Keyboard.TAB:i=tabbables.index(target);if(a.shiftKey&&isTopNavItem&&target.hasClass(settings.openClass)){_togglePanel.call(b,a,true);next=topnavitems.filter(':lt('+topnavitems.index(topli)+'):last');if(next.children('.'+settings.panelClass).length){found=next.children().attr('aria-expanded','true').addClass(settings.openClass).filter('.'+settings.panelClass).attr('aria-hidden','false').find(':tabbable:last').focus()}}else if(a.shiftKey&&i>0){found=(tabbables.filter(':lt('+i+'):last').focus().length===1)}else if(!a.shiftKey&&i<tabbables.length-1){found=(tabbables.filter(':gt('+i+'):first').focus().length===1)}else if(j.opera&&opera.toString()==="[object Opera]"){tabbables=$(':tabbable');i=tabbables.index(target);if(a.shiftKey){found=($(':tabbable:lt('+$(':tabbable').index(target)+'):last').focus().length===1)}else{found=($(':tabbable:gt('+$(':tabbable').index(target)+'):first').focus().length===1)}}if(found){a.preventDefault()}break;case Keyboard.SPACE:if(isTopNavItem){a.preventDefault();_clickHandler.call(b,a)}else{return true}break;case Keyboard.ENTER:return true;break;default:clearTimeout(this.keydownTimeoutID);keydownSearchString+=newString!==keydownSearchString?newString:'';if(keydownSearchString.length===0){return}this.keydownTimeoutID=setTimeout(function(){keydownSearchString=''},keydownTimeoutDuration);if(isTopNavItem&&!target.hasClass(settings.openClass)){tabbables=tabbables.filter(':not(.'+settings.panelClass+' :tabbable)')}else{tabbables=topli.find(':tabbable')}if(a.shiftKey){tabbables=$(tabbables.get().reverse())}for(i=0;i<tabbables.length;i++){o=tabbables.eq(i);if(o.is(target)){start=(keydownSearchString.length===1)?i+1:i;break}}regex=new RegExp('^'+keydownSearchString.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,'\\$&'),'i');for(i=start;i<tabbables.length;i++){o=tabbables.eq(i);label=$.trim(o.text());if(regex.test(label)){found=true;o.focus();break}}if(!found){for(i=0;i<start;i++){o=tabbables.eq(i);label=$.trim(o.text());if(regex.test(label)){o.focus();break}}}break}b.justFocused=false};_mouseDownHandler=function(a){if($(a.target).is(this.settings.panelClass)||$(a.target).closest(":focusable").length){this.mouseFocused=true}this.mouseTimeoutID=setTimeout(function(){clearTimeout(this.focusTimeoutID)},1)};_mouseOverHandler=function(a){clearTimeout(this.mouseTimeoutID);$(a.target).addClass(this.settings.hoverClass);_togglePanel.call(this,a);if($(a.target).is(':tabbable')){$('html').on('keydown.accessible-megamenu',$.proxy(_keyDownHandler,a.target))}};_mouseOutHandler=function(a){var b=this;$(a.target).removeClass(b.settings.hoverClass);b.mouseTimeoutID=setTimeout(function(){_togglePanel.call(b,a,true)},250);if($(a.target).is(':tabbable')){$('html').off('keydown.accessible-megamenu')}};_toggleExpandedEventHandlers=function(a){var b=this.menu;if(a){$('html').off('mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu');b.find('[aria-expanded].'+this.settings.panelClass).off('DOMAttrModified.accessible-megamenu')}else{$('html').on('mouseup.outside-accessible-megamenu, touchend.outside-accessible-megamenu, mspointerup.outside-accessible-megamenu,  pointerup.outside-accessible-megamenu',$.proxy(_clickOutsideHandler,this));b.find('[aria-expanded=true].'+this.settings.panelClass).on('DOMAttrModified.accessible-megamenu',$.proxy(_DOMAttrModifiedHandler,this))}};return{constructor:AccessibleMegaMenu,init:function(){var a=this.settings,nav=$(this.element),menu=this.menu=nav.find(a.menuSelector).first(),topnavitems=menu.children();this.start(a,nav,menu,topnavitems)},start:function(c,d,e,f){var g=this;this.settings=c;this.menu=e;this.topnavitems=f;d.attr("role","navigation");e.addClass(c.menuClass);f.each(function(i,a){var b,topnavitempanel;a=$(a);a.addClass(c.topNavItemClass);b=a.find(":tabbable:first");topnavitempanel=a.children(":not(:tabbable):last");_addUniqueId.call(g,b);if(topnavitempanel.length){_addUniqueId.call(g,topnavitempanel);b.attr({"aria-haspopup":true,"aria-controls":topnavitempanel.attr("id"),"aria-expanded":false});topnavitempanel.attr({"role":"group","aria-expanded":false,"aria-hidden":true}).addClass(c.panelClass).not("[aria-labelledby]").attr("aria-labelledby",b.attr("id"))}});this.panels=e.find("."+c.panelClass);e.on("focusin.accessible-megamenu",":focusable, ."+c.panelClass,$.proxy(_focusInHandler,this)).on("focusout.accessible-megamenu",":focusable, ."+c.panelClass,$.proxy(_focusOutHandler,this)).on("keydown.accessible-megamenu",$.proxy(_keyDownHandler,this)).on("mouseover.accessible-megamenu",$.proxy(_mouseOverHandler,this)).on("mouseout.accessible-megamenu",$.proxy(_mouseOutHandler,this)).on("mousedown.accessible-megamenu",$.proxy(_mouseDownHandler,this));if(isTouch){e.on("touchstart.accessible-megamenu",$.proxy(_clickHandler,this))}e.find("hr").attr("role","separator");if($(k.activeElement).closest(e).length){$(k.activeElement).trigger("focusin.accessible-megamenu")}},getDefaults:function(){return this._defaults},getOption:function(a){return this.settings[a]},getAllOptions:function(){return this.settings},setOption:function(a,b,c){this.settings[a]=b;if(c){this.init()}}}}());$.fn[l]=function(a){return this.each(function(){if(!$.data(this,"plugin_"+l)){$.data(this,"plugin_"+l,new $.fn[l].AccessibleMegaMenu(this,a))}})};$.fn[l].AccessibleMegaMenu=AccessibleMegaMenu;function visible(a){return $.expr.filters.visible(a)&&!$(a).parents().addBack().filter(function(){return $.css(this,"visibility")==="hidden"}).length}function focusable(a,b){var c,mapName,img,nodeName=a.nodeName.toLowerCase();if("area"===nodeName){c=a.parentNode;mapName=c.name;if(!a.href||!mapName||c.nodeName.toLowerCase()!=="map"){return false}img=$("img[usemap=#"+mapName+"]")[0];return!!img&&visible(img)}return(/input|select|textarea|button|object/.test(nodeName)?!a.disabled:"a"===nodeName?a.href||b:b)&&visible(a)}$.extend($.expr[":"],{data:$.expr.createPseudo?$.expr.createPseudo(function(b){return function(a){return!!$.data(a,b)}}):function(a,i,b){return!!$.data(a,b[3])},focusable:function(a){return focusable(a,!isNaN($.attr(a,"tabindex")))},tabbable:function(a){var b=$.attr(a,"tabindex"),isTabIndexNaN=isNaN(b);return(isTabIndexNaN||b>=0)&&focusable(a,!isTabIndexNaN)}})}(jQuery,window,document));
